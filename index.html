<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–∫—Ç–∏–≤–µ–Ω –î–Ω–µ–≤–Ω–∏–∫</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <style>
        /* --- –û–°–ù–û–í–ù–ò –°–¢–ò–õ–û–í–ï --- */
        html, body {
            background-color: #f4f4f9 !important;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: sans-serif;
            text-align: center;
        }

        /* LOADING SCREEN */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255,255,255,0.9); z-index: 9999;
            display: none; flex-direction: column; justify-content: center; align-items: center; color: #333;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* DARK MODE */
        @media (prefers-color-scheme: dark) {
            body, html { background-color: #1e1e1e !important; color: #f4f4f9 !important; }
            h1 { color: #f4f4f9 !important; }
            #login-screen, #loading-screen { background-color: #1e1e1e !important; color: #fff !important; }
            .login-box, .settings-content { background-color: #2a2a2a !important; box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important; }
            .login-box h2, .settings-content h2 { color: #f4f4f9 !important; }
            .login-input, input[type="text"], input[type="password"] { background-color: #333 !important; color: #f4f4f9 !important; border: 1px solid #555 !important; outline: none !important; }
            #toggle-auth { color: #81c784 !important; }
            .reel { background-color: #333 !important; border: 3px solid #999 !important; }
            .date-header { background-color: #555 !important; }
            .color-8, #activity-log .color-8 { color: #333 !important; }
        }
        
        /* –ï–ö–†–ê–ù–ò */
        #app-screen { display: none; padding: 20px; }
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; width: 100%; }
        
        /* LOGIN UI */
        .login-box { padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 350px; width: 90%; background-color: #fff; display: flex; flex-direction: column; gap: 10px; }
        .login-box h2 { margin-bottom: 20px; color: #333; }
        
        .login-input { width: 100%; padding: 12px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; display: block; }

        /* –ë–£–¢–û–ù–ò */
        .login-btn, .google-btn, .save-btn, .logout-btn { width: 100%; padding: 12px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold; display: block; text-transform: uppercase; margin-top: 10px; }
        
        .login-btn, .save-btn { background-color: #2196F3 !important; color: white !important; }
        .google-btn { background-color: #DB4437 !important; color: white !important; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .logout-btn { background-color: #f44336 !important; color: white !important; margin-top: 20px; }

        #toggle-auth { margin-top: 20px; color: #2196F3; cursor: pointer; font-size: 14px; text-decoration: underline; }
        #auth-error { color: #f44336; margin-top: 15px; font-size: 14px; font-weight: bold; background: rgba(255, 0, 0, 0.1); padding: 5px; border-radius: 4px; display: none; }

        /* APP HEADER & BUTTONS */
        h1 { color: #333; margin-top: 0; }
        #settings-btn { position: fixed; top: 15px; right: 15px; font-size: 24px; background: none; border: none; cursor: pointer; z-index: 2000; }
        #profile-btn { position: fixed; top: 15px; left: 15px; font-size: 24px; background: none; border: none; cursor: pointer; z-index: 2000; }
        
        /* REEL UI */
        #slot-container { display: flex; justify-content: center; align-items: center; margin: 30px auto; }
        .reel { width: 250px; height: 50px; border: 3px solid #666; border-radius: 10px; overflow: hidden; position: relative; cursor: grab; box-shadow: 0 5px 15px rgba(0,0,0,0.2); touch-action: none; background-color: #fff; -webkit-user-select: none; user-select: none; }
        .reel-items { position: absolute; width: 100%; display: flex; flex-direction: column; transform: translateY(0); transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .reel-item { height: 50px !important; min-height: 50px !important; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: bold; color: #333; text-shadow: none; border-bottom: 1px solid rgba(0,0,0,0.1); box-sizing: border-box; -webkit-user-select: none; user-select: none; }
        .active-activity { box-shadow: 0 0 20px 5px rgba(255, 165, 0, 0.9); }
        
        /* LOG UI */
        #log-container { margin-top: 40px; padding: 0 20px 20px 20px; }
        #log-container h2 { display: none; }
        #activity-log { list-style: none; padding: 0; margin: 0 auto; max-width: 300px; text-align: center; }
        #activity-log li { list-style: none; padding: 10px; margin-bottom: 8px; border-radius: 4px; color: #fff; font-weight: 500; text-align: center; word-break: break-word; }
        .date-header { background-color: #333 !important; color: #fff !important; margin: 20px auto !important; padding: 8px 10px !important; border-radius: 6px; display: block; max-width: 300px; }

        /* MODALS (Settings & Profile) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 3000; overflow-y: auto; }
        .settings-content { background-color: #fff; margin: 20px auto; padding: 20px; width: 90%; max-width: 400px; border-radius: 10px; text-align: left; display: flex; flex-direction: column; gap: 10px;}
        .setting-row { display: flex; align-items: center; margin-bottom: 10px; gap: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .setting-row input[type="text"] { flex-grow: 1; padding: 5px; font-size: 16px; }
        .setting-row input[type="color"] { width: 40px; height: 40px; border: none; cursor: pointer; background: none; }
        .label-small { font-size: 10px; color: #666; text-align: center; width: 40px; }
        .delete-btn { background-color: #f44336; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 4px; font-weight: bold; margin-left: 10px; }
        .add-row { display: flex; gap: 10px; margin-top: 20px; padding-top: 10px; border-top: 1px dashed #ccc; }
        .add-row input[type="text"] { flex-grow: 1; width: 100%; padding: 8px; }
        .add-btn { background-color: #2196F3; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 5px; font-size: 16px; }
        
        /* Close Button for Modals */
        .close-modal {
            align-self: flex-end;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="spinner"></div>
        <p>–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</p>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <h2 id="auth-title">–í—Ö–æ–¥ –≤ –ê–∫—Ç–∏–≤–µ–Ω –î–Ω–µ–≤–Ω–∏–∫</h2>
            <input type="email" id="auth-email" class="login-input" placeholder="–ò–º–µ–π–ª –∞–¥—Ä–µ—Å" autocomplete="email">
            <input type="password" id="auth-password" class="login-input" placeholder="–ü–∞—Ä–æ–ª–∞" autocomplete="current-password">
            
            <button id="btn-email-auth" class="login-btn">–í–•–û–î</button>
            <button id="btn-google-auth" class="google-btn">
                <i class="fa fa-google"></i> –í–•–û–î —Å Google
            </button>
            
            <p id="toggle-auth">–ù—è–º–∞—à –∞–∫–∞—É–Ω—Ç? –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ.</p>
            <p id="auth-error"></p>
        </div>
    </div>
    
    <div id="app-screen">
        <button id="profile-btn">üë§</button> <button id="settings-btn">‚öôÔ∏è</button> <div id="settings-modal" class="modal">
            <div class="settings-content">
                <span class="close-modal" onclick="document.getElementById('settings-modal').style.display='none'">&times;</span>
                <h2>–î–µ–π–Ω–æ—Å—Ç–∏</h2>
                <div id="settings-list"></div>
                <div class="add-row">
                    <input type="text" id="new-activity-name" placeholder="–ò–º–µ –Ω–∞ –Ω–æ–≤–∞ –¥–µ–π–Ω–æ—Å—Ç">
                    <button id="btn-add-activity" class="add-btn">‚ûï</button>
                </div>
                <button id="btn-save-settings" class="save-btn">–ó–ê–ü–ê–ó–ò</button>
            </div>
        </div>

        <div id="profile-modal" class="modal">
            <div class="settings-content">
                <span class="close-modal" onclick="document.getElementById('profile-modal').style.display='none'">&times;</span>
                <h2>–ú–æ—è—Ç –ü—Ä–æ—Ñ–∏–ª</h2>
                <p>–õ–æ–≥–Ω–∞—Ç –∫–∞—Ç–æ:</p>
                <p id="user-email-display" style="font-weight: bold; margin-bottom: 20px; word-break: break-all;"></p>
                
                <hr style="width:100%; border:0; border-top:1px solid #eee;">
                
                <h3>–°–º—è–Ω–∞ –Ω–∞ –ø–∞—Ä–æ–ª–∞</h3>
                <input type="password" id="new-password-input" class="login-input" placeholder="–ù–æ–≤–∞ –ø–∞—Ä–æ–ª–∞">
                <button id="btn-change-password" class="save-btn" style="background-color: #FF9800 !important;">–°–ú–ï–ù–ò –ü–ê–†–û–õ–ê</button>
                
                <hr style="width:100%; border:0; border-top:1px solid #eee; margin-top: 20px;">
                
                <button id="btn-logout-action" class="logout-btn">–ò–ó–•–û–î</button>
            </div>
        </div>

        <div>
            <h1>–ê–∫—Ç–∏–≤–µ–Ω –î–Ω–µ–≤–Ω–∏–∫</h1>
            <div id="slot-container">
                <div id="main-reel" class="reel">
                    <div id="reel-items" class="reel-items"></div>
                </div>
            </div>
            <div id="current-activity-display" style="text-align: center; margin-top: 20px; font-size: 16px; font-weight: bold; color: #555;"></div>
        </div>

        <div id="log-container">
            <h2>–õ–æ–≥</h2>
            <ul id="activity-log"></ul>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDPzM2ncCIX43TgcSOym51kUQIPZVH2w84",
            authDomain: "daily-routine-f3688.firebaseapp.com",
            projectId: "daily-routine-f3688",
            storageBucket: "daily-routine-f3688.firebasestorage.app",
            messagingSenderId: "119560133908",
            appId: "1:119560133908:web:9bce81885e2df34434b601",
            measurementId: "G-BQCYBB91KR"
        };

        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const usersCollection = db.collection('users');

        let defaultActivities = [
            { name: '–°—Ç–∞–≤–∞–Ω–µ', bg: '#e57373', text: '#ffffff' }, { name: '–õ—è–≥–∞–Ω–µ', bg: '#64b5f6', text: '#ffffff' }, { name: '–û–±—è–¥', bg: '#81c784', text: '#ffffff' }, { name: '–ó–∞–∫—É—Å–∫–∞', bg: '#ffb74d', text: '#ffffff' }, { name: '–í–µ—á–µ—Ä—è', bg: '#ba68c8', text: '#ffffff' }, { name: '–§–∏–ª–º–∏', bg: '#4db6ac', text: '#ffffff' }, { name: '–§–∏—Ç–Ω–µ—Å', bg: '#ff8a65', text: '#ffffff' }, { name: '–†–∞–±–æ—Ç–∞', bg: '#a1887f', text: '#ffffff' }, { name: '–ß–µ—Ç–µ–Ω–µ', bg: '#fff176', text: '#333333' }, { name: '–ü–æ—á–∏–≤–∫–∞', bg: '#90a4ae', text: '#ffffff' }
        ];
        let activities = JSON.parse(JSON.stringify(defaultActivities));
        let activityData = []; 
        let activeActivity = null; 
        let currentUserID = null; 
        
        const itemHeight = 50; 
        let isLoginMode = true; 
        let isDragging = false; 
        let startY = 0;
        let currentTranslateY = 0;
        let pressTimer = null;

        document.addEventListener('DOMContentLoaded', () => {
            const loadingScreen = document.getElementById('loading-screen');
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app-screen');
            const authTitle = document.getElementById('auth-title');
            const authError = document.getElementById('auth-error');
            const authEmail = document.getElementById('auth-email');
            const authPassword = document.getElementById('auth-password');
            const btnEmailAuth = document.getElementById('btn-email-auth');
            const btnGoogleAuth = document.getElementById('btn-google-auth');
            const toggleAuthBtn = document.getElementById('toggle-auth');
            
            const profileBtn = document.getElementById('profile-btn');
            const profileModal = document.getElementById('profile-modal');
            const userEmailDisplay = document.getElementById('user-email-display');
            const btnChangePassword = document.getElementById('btn-change-password');
            const btnLogoutAction = document.getElementById('btn-logout-action');
            const newPasswordInput = document.getElementById('new-password-input');

            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const btnSaveSettings = document.getElementById('btn-save-settings');
            const btnAddActivity = document.getElementById('btn-add-activity');
            const mainReel = document.getElementById('main-reel');

            // --- AUTH STATE LISTENER ---
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUserID = user.uid;
                    userEmailDisplay.textContent = user.email || "Google User";
                    
                    await loadState();
                    renderLog();
                    updateDisplay(0);
                    
                    loadingScreen.style.display = 'none';
                    loginScreen.style.display = 'none';
                    appScreen.style.display = 'block';
                } else {
                    currentUserID = null;
                    loadingScreen.style.display = 'none';
                    appScreen.style.display = 'none';
                    loginScreen.style.display = 'flex';
                }
            });

            // --- AUTH UI HANDLERS ---
            toggleAuthBtn.addEventListener('click', () => {
                isLoginMode = !isLoginMode;
                authError.style.display = 'none';
                if (isLoginMode) {
                    authTitle.textContent = '–í—Ö–æ–¥ –≤ –ê–∫—Ç–∏–≤–µ–Ω –î–Ω–µ–≤–Ω–∏–∫';
                    toggleAuthBtn.textContent = '–ù—è–º–∞—à –∞–∫–∞—É–Ω—Ç? –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ.';
                    btnEmailAuth.textContent = '–í–•–û–î';
                } else {
                    authTitle.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
                    toggleAuthBtn.textContent = '–ò–º–∞—à –∞–∫–∞—É–Ω—Ç? –í–ª–µ–∑.';
                    btnEmailAuth.textContent = '–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø';
                }
            });

            btnEmailAuth.addEventListener('click', async () => {
                const email = authEmail.value;
                const password = authPassword.value;
                authError.style.display = 'none';
                if (email.length < 5 || password.length < 6) {
                    authError.textContent = '–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–µ–Ω –∏–º–µ–π–ª –∏ –ø–∞—Ä–æ–ª–∞ (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–∞).';
                    authError.style.display = 'block';
                    return;
                }
                loadingScreen.style.display = 'flex';
                try {
                    if (isLoginMode) {
                        await auth.signInWithEmailAndPassword(email, password);
                    } else {
                        await auth.createUserWithEmailAndPassword(email, password);
                    }
                } catch (error) {
                    loadingScreen.style.display = 'none';
                    authError.textContent = '–ì—Ä–µ—à–∫–∞: ' + error.message;
                    authError.style.display = 'block';
                }
            });

            btnGoogleAuth.addEventListener('click', async () => {
                authError.style.display = 'none';
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    authError.textContent = '–ì—Ä–µ—à–∫–∞ —Å Google: ' + error.message;
                    authError.style.display = 'block';
                    if (error.code === 'auth/popup-blocked') {
                         alert("–ú–æ–ª—è, —Ä–∞–∑—Ä–µ—à–µ—Ç–µ –∏–∑—Å–∫–∞—á–∞—â–∏—Ç–µ –ø—Ä–æ–∑–æ—Ä—Ü–∏ (Pop-ups) –∑–∞ —Ç–æ–∑–∏ —Å–∞–π—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ –Ω–∞ –±—Ä–∞—É–∑—ä—Ä–∞.");
                    }
                }
            });

            // --- PROFILE & LOGOUT HANDLERS ---
            profileBtn.addEventListener('click', () => {
                profileModal.style.display = 'block';
                newPasswordInput.value = ''; // Clear input
            });

            btnLogoutAction.addEventListener('click', () => {
                profileModal.style.display = 'none';
                auth.signOut();
            });

            btnChangePassword.addEventListener('click', () => {
                const newPass = newPasswordInput.value;
                if (newPass.length < 6) {
                    alert("–ü–∞—Ä–æ–ª–∞—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –ø–æ–Ω–µ 6 —Å–∏–º–≤–æ–ª–∞.");
                    return;
                }
                const user = auth.currentUser;
                user.updatePassword(newPass).then(() => {
                    alert("–ü–∞—Ä–æ–ª–∞—Ç–∞ –µ —Å–º–µ–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!");
                    newPasswordInput.value = '';
                }).catch((error) => {
                    if (error.code === 'auth/requires-recent-login') {
                        alert("–ó–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç, –º–æ–ª—è –∏–∑–ª–µ–∑—Ç–µ –∏ –≤–ª–µ–∑—Ç–µ –æ—Ç–Ω–æ–≤–æ, –∑–∞ –¥–∞ —Å–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª–∞—Ç–∞ —Å–∏.");
                        auth.signOut();
                    } else {
                        alert("–ì—Ä–µ—à–∫–∞: " + error.message);
                    }
                });
            });


            // --- SETTINGS UI ---
            settingsBtn.addEventListener('click', () => {
                generateSettingsList();
                settingsModal.style.display = 'block';
            });

            btnSaveSettings.addEventListener('click', saveAndCloseSettings);
            
            btnAddActivity.addEventListener('click', () => {
                const input = document.getElementById('new-activity-name');
                const name = input.value.trim();
                if (name) {
                    const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                    activities.push({ name, bg: randomColor, text: '#ffffff' });
                    generateSettingsList();
                    input.value = '';
                }
            });
            
            // --- REEL EVENTS ---
            mainReel.addEventListener('contextmenu', (e) => e.preventDefault());
            mainReel.addEventListener('touchstart', handleTouchStart);
            mainReel.addEventListener('touchmove', handleTouchMove);
            mainReel.addEventListener('touchend', handleTouchEnd);
        });

        // --- LOGIC FUNCTIONS ---

        function generateSettingsList() {
            const list = document.getElementById('settings-list');
            list.innerHTML = '';
            activities.forEach((act, index) => {
                const row = document.createElement('div');
                row.className = 'setting-row';
                row.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <input type="color" id="bg-color-${index}" value="${act.bg}">
                        <span class="label-small">–§–æ–Ω</span>
                    </div>
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <input type="color" id="text-color-${index}" value="${act.text}">
                        <span class="label-small">–¢–µ–∫—Å—Ç</span>
                    </div>
                    <input type="text" id="name-${index}" value="${act.name}">
                    <button class="delete-btn" onclick="removeActivity(${index})">[X]</button>
                `;
                list.appendChild(row);
            });
        }

        window.removeActivity = function(index) {
            if (activities.length > 1 && confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?")) {
                activities.splice(index, 1);
                generateSettingsList();
            }
        };

        function saveAndCloseSettings() {
            for (let i = 0; i < activities.length; i++) {
                const name = document.getElementById(`name-${i}`)?.value;
                const bg = document.getElementById(`bg-color-${i}`)?.value;
                const text = document.getElementById(`text-color-${i}`)?.value;
                if (name && bg && text) {
                    activities[i] = { name, bg, text };
                }
            }
            if (activeActivity && activeActivity.colorIndex >= activities.length) activeActivity = null;
            
            saveState();
            generateReelContent();
            renderLog();
            updateDisplay(getCurrentTransformY());
            document.getElementById('settings-modal').style.display = 'none';
        }

        async function saveState() {
            if (!currentUserID) return;
            const data = {
                activities: activities,
                activityLog: activityData,
                activeActivity: activeActivity,
                lastLogDate: new Date().toISOString().slice(0, 10)
            };
            try { await usersCollection.doc(currentUserID).set(data, { merge: true }); } catch(e) { console.error(e); }
        }

        async function loadState() {
            if (!currentUserID) return;
            try {
                const doc = await usersCollection.doc(currentUserID).get();
                if (doc.exists) {
                    const data = doc.data();
                    if (data.activities) activities = data.activities;
                    const today = new Date().toISOString().slice(0, 10);
                    if (data.lastLogDate === today) {
                        activityData = data.activityLog || [];
                        activeActivity = data.activeActivity || null;
                    } else {
                        activityData = [];
                        activeActivity = null;
                    }
                }
            } catch(e) { console.error(e); }
            generateReelContent();
        }

        function generateReelContent() {
            const reelItems = document.getElementById('reel-items');
            reelItems.innerHTML = '';
            activities.forEach((act, index) => {
                const div = document.createElement('div');
                div.className = 'reel-item';
                div.textContent = act.name;
                div.style.backgroundColor = act.bg;
                div.style.color = act.text;
                div.dataset.activityIndex = index;
                reelItems.appendChild(div);
            });
        }

        function renderLog() {
            const log = document.getElementById('activity-log');
            log.innerHTML = '';
            const today = new Date();

            if (activeActivity) {
                const li = document.createElement('li');
                const act = activities[activeActivity.colorIndex] || {bg:'#ccc', text:'#000'};
                li.style.backgroundColor = act.bg;
                li.style.color = act.text;
                li.textContent = `–ó–ê–ü–û–ß–ù–ê–¢–û: ${activeActivity.name} –≤ ${new Date(activeActivity.startTime).toLocaleTimeString()}`;
                log.appendChild(li);
            }

            [...activityData].reverse().forEach(entry => {
                const li = document.createElement('li');
                const act = activities[entry.colorIndex] || {bg:'#ccc', text:'#000'};
                li.style.backgroundColor = act.bg;
                li.style.color = act.text;
                
                const start = new Date(entry.startTime);
                const end = new Date(entry.endTime);
                const duration = Math.floor((end - start) / 1000);
                const hrs = Math.floor(duration / 3600);
                const mins = Math.floor((duration % 3600) / 60);
                const secs = duration % 60;
                const durStr = (hrs>0?hrs+'—á ':'') + (mins>0?mins+'–º–∏–Ω ':'') + secs+'—Å–µ–∫';

                li.textContent = `${entry.name}: ${start.toLocaleTimeString()} - ${end.toLocaleTimeString()} | ${durStr}`;
                log.appendChild(li);
            });

            const dateLi = document.createElement('li');
            dateLi.className = 'date-header';
            dateLi.textContent = today.toLocaleDateString('bg-BG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            log.appendChild(dateLi);
        }

        function getCurrentTransformY() {
            const style = window.getComputedStyle(document.getElementById('reel-items'));
            const matrix = new WebKitCSSMatrix(style.transform);
            return matrix.m42;
        }

        function updateDisplay(y) {
            const index = Math.abs(Math.round(y / 50));
            if (index < activities.length) {
                const act = activities[index];
                const display = document.getElementById('current-activity-display');
                const mainReel = document.getElementById('main-reel');
                
                mainReel.classList.remove('active-activity');
                if (auth.currentUser && activeActivity) {
                    mainReel.classList.add('active-activity');
                }
                
                display.innerHTML = `–ò–∑–±—Ä–∞–Ω–∞: <span style="padding: 2px 5px; border-radius: 4px; background-color: ${act.bg}; color: ${act.text};">${act.name}</span>. –î–æ–∫–æ—Å–Ω–µ—Ç–µ –∑–∞ —Å—Ç–∞—Ä—Ç.`;
            }
        }
        
        function snapToClosestItem() {
            let y = getCurrentTransformY();
            let snapped = Math.round(y / 50) * 50;
            let max = -(activities.length - 1) * 50;
            let final = Math.max(max, Math.min(0, snapped));
            
            const reelItems = document.getElementById('reel-items');
            reelItems.style.transform = `translateY(${final}px)`;
            currentTranslateY = final;
            updateDisplay(final);
        }

        function handleTap() {
            if (!currentUserID) return;
            snapToClosestItem();
            
            const index = Math.abs(Math.round(getCurrentTransformY() / 50));
            if (index >= activities.length) return;
            
            const name = activities[index].name;
            const now = new Date().toISOString();

            if (activeActivity && activeActivity.colorIndex === index) return;

            if (!activeActivity) {
                activeActivity = { name, startTime: now, colorIndex: index };
            } else {
                activityData.push({
                    name: activeActivity.name,
                    colorIndex: activeActivity.colorIndex,
                    startTime: activeActivity.startTime,
                    endTime: now
                });
                activeActivity = { name, startTime: now, colorIndex: index };
            }
            renderLog();
            saveState(); 
        }

        function handleTouchStart(e) {
            isDragging = false;
            startY = e.touches[0].clientY;
            currentTranslateY = getCurrentTransformY();
            document.getElementById('reel-items').style.transition = 'none';
            
            pressTimer = setTimeout(() => {
                if (!isDragging) {
                    const index = Math.abs(Math.round(currentTranslateY / 50));
                    const newName = prompt("–†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ:", activities[index].name);
                    if (newName) {
                        activities[index].name = newName;
                        generateReelContent();
                        saveState();
                        updateDisplay(currentTranslateY);
                    }
                }
            }, 700);
        }

        function handleTouchMove(e) {
            const dy = e.touches[0].clientY - startY;
            if (Math.abs(dy) > 5) {
                isDragging = true;
                clearTimeout(pressTimer);
            }
            const newY = currentTranslateY + dy;
            const max = -(activities.length - 1) * 50;
            const bounded = Math.max(max, Math.min(0, newY));
            document.getElementById('reel-items').style.transform = `translateY(${bounded}px)`;
        }

        function handleTouchEnd() {
            clearTimeout(pressTimer);
            document.getElementById('reel-items').style.transition = 'transform 0.2s ease-out';
            if (isDragging) snapToClosestItem();
            else handleTap();
            isDragging = false;
        }
    </script>
</body>
</html>
