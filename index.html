<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ê–∫—Ç–∏–≤–µ–Ω –î–Ω–µ–≤–Ω–∏–∫ (Debug)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&family=Orbitron:wght@500&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
    
    <style>
        /* --- BASE STYLES --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            background-color: #f4f4f9; margin: 0; padding: 0; min-height: 100vh;
            font-family: sans-serif; text-align: center; color: #333;
        }

        /* DEBUG CONSOLE (–ó–∞ –¥–∞ –≤–∏–¥–∏–º –≥—Ä–µ—à–∫–∞—Ç–∞) */
        #debug-console {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 100px;
            background: #000; color: #0f0; font-family: monospace; font-size: 10px;
            text-align: left; padding: 5px; overflow-y: scroll; z-index: 20000;
            border-top: 2px solid #333; display: block;
        }

        /* DARK MODE */
        @media (prefers-color-scheme: dark) {
            body { background-color: #1e1e1e !important; color: #fff !important; }
            .login-box { background-color: #2a2a2a !important; }
            .login-input { background-color: #333 !important; color: #fff !important; border: 1px solid #555 !important; }
            .reel { background-color: #333 !important; border-color: #999 !important; }
        }

        /* SCREENS */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255,255,255,0.95); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #333;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding-bottom: 120px; }
        #app-screen { display: none; padding: 20px; padding-bottom: 120px; }

        /* UI ELEMENTS */
        .login-box { padding: 30px; border-radius: 10px; background: #fff; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 90%; max-width: 350px; }
        .login-input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; text-transform: uppercase; }
        .btn-primary { background-color: #2196F3; color: white; }
        .btn-google { background-color: #DB4437; color: white; }
        .btn-danger { background-color: #f44336; color: white; }
        
        /* REEL */
        .reel { width: 250px; height: 150px; border: 3px solid #666; border-radius: 10px; overflow: hidden; position: relative; margin: 20px auto; background: #fff; }
        .reel-items { position: absolute; width: 100%; top: 50px; }
        .reel-item { height: 50px; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 18px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .active-activity { box-shadow: 0 0 20px 5px rgba(33, 150, 243, 0.5); border-color: #2196F3 !important; }

        /* LOG */
        #activity-log { list-style: none; padding: 0; max-width: 350px; margin: 20px auto; }
        #activity-log li { padding: 10px; margin-bottom: 8px; border-radius: 4px; color: #fff; }
        .date-header { background: #555; color: #fff; padding: 5px 10px; border-radius: 15px; margin: 20px auto; display: inline-block; font-size: 12px; }
        
        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; }
        .settings-content { background: #fff; margin: 10vh auto; padding: 20px; width: 90%; border-radius: 10px; max-height: 80vh; overflow-y: auto; }
        .setting-row { display: flex; gap: 5px; margin-bottom: 10px; align-items: center; }
        .setting-row input[type=text] { flex: 1; padding: 8px; }
    </style>
</head>
<body>

    <div id="debug-console">System Ready. Waiting for user input...<br></div>

    <div id="loading-screen" style="display:none;">
        <div class="spinner"></div>
        <p>–ú–æ–ª—è –∏–∑—á–∞–∫–∞–π—Ç–µ...</p>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <h2>–í–•–û–î</h2>
            <input type="email" id="auth-email" class="login-input" placeholder="–ò–º–µ–π–ª">
            <input type="password" id="auth-password" class="login-input" placeholder="–ü–∞—Ä–æ–ª–∞">
            <button id="btn-login" class="btn btn-primary">–í–õ–ï–ó</button>
            <button id="btn-register" class="btn btn-primary" style="background:#4CAF50">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
            <button id="btn-google" class="btn btn-google"><i class="fa fa-google"></i> GOOGLE</button>
        </div>
    </div>

    <div id="app-screen">
        <button onclick="document.getElementById('settings-modal').style.display='block'" style="position:fixed; top:10px; right:10px; font-size:24px; background:none; border:none;">‚öôÔ∏è</button>
        <button onclick="firebase.auth().signOut()" style="position:fixed; top:10px; left:10px; font-size:24px; background:none; border:none;">üö™</button>
        
        <h1>–ê–∫—Ç–∏–≤–µ–Ω –î–Ω–µ–≤–Ω–∏–∫</h1>
        <div id="main-reel" class="reel"><div id="reel-items" class="reel-items"></div></div>
        <div id="current-activity-display" style="min-height: 20px; font-weight: bold;"></div>
        <ul id="activity-log"></ul>
    </div>

    <div id="settings-modal" class="modal">
        <div class="settings-content">
            <button onclick="document.getElementById('settings-modal').style.display='none'" style="float:right; font-size:20px; border:none; background:none;">X</button>
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div id="settings-list"></div>
            <button onclick="saveSettings()" class="btn btn-primary">–ó–ê–ü–ê–ó–ò</button>
        </div>
    </div>

    <script>
        // LOGGING FUNCTION
        function logToScreen(msg) {
            const c = document.getElementById('debug-console');
            const line = document.createElement('div');
            line.textContent = `> ${msg}`;
            c.appendChild(line);
            c.scrollTop = c.scrollHeight;
            console.log(msg);
        }

        const firebaseConfig = {
            apiKey: "AIzaSyDPzM2ncCIX43TgcSOym51kUQIPZVH2w84",
            authDomain: "daily-routine-f3688.firebaseapp.com",
            projectId: "daily-routine-f3688",
            storageBucket: "daily-routine-f3688.firebasestorage.app",
            messagingSenderId: "119560133908",
            appId: "1:119560133908:web:9bce81885e2df34434b601",
            measurementId: "G-BQCYBB91KR"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            logToScreen("Firebase initialized successfully.");
        } catch (e) {
            logToScreen("FIREBASE ERROR: " + e.message);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        // DATA
        let activities = [
            {name:'–°—Ç–∞–≤–∞–Ω–µ', bg:'#e57373', text:'#fff'}, {name:'–õ—è–≥–∞–Ω–µ', bg:'#64b5f6', text:'#fff'}, 
            {name:'–û–±—è–¥', bg:'#81c784', text:'#fff'}, {name:'–†–∞–±–æ—Ç–∞', bg:'#a1887f', text:'#fff'},
            {name:'–§–∏—Ç–Ω–µ—Å', bg:'#ff8a65', text:'#fff'}
        ];
        let activityData = [];
        let activeActivity = null;

        // AUTH LISTENER
        auth.onAuthStateChanged(user => {
            if (user) {
                logToScreen("User logged in: " + user.email);
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'block';
                loadData();
            } else {
                logToScreen("No user logged in.");
                currentUser = null;
                document.getElementById('app-screen').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
            }
            document.getElementById('loading-screen').style.display = 'none';
        });

        // BUTTONS
        document.getElementById('btn-login').onclick = () => {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-password').value;
            logToScreen("Attempting login with: " + e);
            document.getElementById('loading-screen').style.display = 'flex';
            auth.signInWithEmailAndPassword(e, p).catch(err => {
                document.getElementById('loading-screen').style.display = 'none';
                logToScreen("LOGIN ERROR: " + err.message);
                alert(err.message);
            });
        };

        document.getElementById('btn-register').onclick = () => {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-password').value;
            logToScreen("Attempting registration...");
            document.getElementById('loading-screen').style.display = 'flex';
            auth.createUserWithEmailAndPassword(e, p).catch(err => {
                document.getElementById('loading-screen').style.display = 'none';
                logToScreen("REG ERROR: " + err.message);
                alert(err.message);
            });
        };

        document.getElementById('btn-google').onclick = () => {
            logToScreen("Starting Google Popup...");
            const p = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(p).catch(err => {
                logToScreen("GOOGLE ERROR: " + err.message);
                alert("Google Error: " + err.message);
            });
        };

        // DATA LOGIC
        async function loadData() {
            if(!currentUser) return;
            logToScreen("Loading data from Firestore...");
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists) {
                    const d = doc.data();
                    if(d.activities) activities = d.activities;
                    const today = new Date().toISOString().slice(0,10);
                    if(d.lastLogDate === today) {
                        activityData = d.activityLog || [];
                        activeActivity = d.activeActivity || null;
                    }
                    logToScreen("Data loaded.");
                } else {
                    logToScreen("No existing data, using defaults.");
                }
                renderReel(); renderLog();
            } catch (e) {
                logToScreen("LOAD ERROR: " + e.message);
            }
        }

        async function saveData() {
            if(!currentUser) return;
            try {
                await db.collection('users').doc(currentUser.uid).set({
                    activities, activityLog: activityData, activeActivity,
                    lastLogDate: new Date().toISOString().slice(0,10)
                }, {merge:true});
                logToScreen("Data saved.");
            } catch(e) {
                logToScreen("SAVE ERROR: " + e.message);
            }
        }

        // UI RENDER
        function renderReel() {
            const c = document.getElementById('reel-items'); c.innerHTML='';
            const setDiv = document.getElementById('settings-list'); setDiv.innerHTML='';
            
            activities.forEach((a, i) => {
                // Reel Item
                const d = document.createElement('div'); d.className='reel-item';
                d.textContent = a.name; d.style.backgroundColor = a.bg; d.style.color = a.text;
                c.appendChild(d);

                // Settings Row
                const row = document.createElement('div'); row.className='setting-row';
                row.innerHTML = `<input type="text" id="n-${i}" value="${a.name}"><input type="color" id="c-${i}" value="${a.bg}">`;
                setDiv.appendChild(row);
            });
        }

        window.saveSettings = function() {
            activities.forEach((a, i) => {
                const n = document.getElementById(`n-${i}`).value;
                const c = document.getElementById(`c-${i}`).value;
                if(n) { a.name = n; a.bg = c; }
            });
            saveData(); renderReel(); renderLog();
            document.getElementById('settings-modal').style.display='none';
        }

        function renderLog() {
            const l = document.getElementById('activity-log'); l.innerHTML='';
            if(activeActivity) {
                const li = document.createElement('li'); 
                const a = activities[activeActivity.colorIndex] || {bg:'#333', text:'#fff'};
                li.textContent = `–ê–ö–¢–ò–í–ù–ê: ${activeActivity.name}`;
                li.style.backgroundColor = a.bg; li.style.color = a.text; li.style.border = "2px solid #fff";
                l.appendChild(li);
            }
            activityData.slice().reverse().forEach(e => {
                const li = document.createElement('li');
                const a = activities[e.colorIndex] || {bg:'#ccc', text:'#000'};
                const start = new Date(e.startTime);
                li.textContent = `${e.name} (${start.toLocaleTimeString()})`;
                li.style.backgroundColor = a.bg; li.style.color = a.text;
                l.appendChild(li);
            });
        }

        // TOUCH LOGIC
        let startY=0, currentY=0, isDrag=false;
        const reel = document.getElementById('main-reel');
        const items = document.getElementById('reel-items');

        reel.addEventListener('touchstart', e => { isDrag=false; startY=e.touches[0].clientY; items.style.transition='none'; });
        reel.addEventListener('touchmove', e => {
            if(Math.abs(e.touches[0].clientY - startY)>5) isDrag=true;
            const dy = e.touches[0].clientY - startY;
            items.style.transform = `translateY(${currentY + dy}px)`;
        });
        reel.addEventListener('touchend', e => {
            const dy = e.changedTouches[0].clientY - startY;
            if(!isDrag) { // Tap
                handleTap();
            } else { // Scroll Snap
                currentY += dy;
                const h = 50;
                currentY = Math.round(currentY/h)*h;
                currentY = Math.max(-(activities.length-1)*h, Math.min(0, currentY));
                items.style.transition = 'transform 0.2s';
                items.style.transform = `translateY(${currentY}px)`;
                updateLabel(currentY);
            }
        });

        function updateLabel(y) {
            const i = Math.abs(y/50);
            if(activities[i]) document.getElementById('current-activity-display').innerText = activities[i].name;
        }

        function handleTap() {
            if(!currentUser) return alert("–í–ª–µ–∑—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª–∞ —Å–∏!");
            const i = Math.abs(currentY/50);
            if(i >= activities.length) return;
            
            const name = activities[i].name;
            const now = new Date().toISOString();

            if(activeActivity && activeActivity.colorIndex === i) return;

            if(activeActivity) {
                activityData.push({ ...activeActivity, endTime: now });
            }
            activeActivity = { name, startTime: now, colorIndex: i };
            saveData(); renderLog();
        }
        
        // Start
        renderReel();
    </script>
</body>
</html>
