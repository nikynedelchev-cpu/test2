<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–∫—Ç–∏–≤–µ–Ω –î–Ω–µ–≤–Ω–∏–∫</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
    
    <style>
        /* --- BASE STYLES (Default / Skin 1) --- */
        html, body {
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: sans-serif;
            text-align: center;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- SKIN 2: NEON (Cyberpunk) --- */
        body.skin-neon {
            background-color: #050505 !important;
            color: #0ff !important;
            font-family: 'Orbitron', sans-serif !important;
        }
        body.skin-neon h1 { color: #0ff !important; text-shadow: 0 0 10px #0ff; }
        body.skin-neon .reel { border-color: #0ff !important; background-color: #111 !important; box-shadow: 0 0 15px #0ff !important; }
        body.skin-neon .reel-item { color: #0ff !important; border-bottom: 1px solid #0ff !important; }
        body.skin-neon .login-btn, body.skin-neon .save-btn, body.skin-neon .add-btn {
            background-color: #000 !important; border: 1px solid #0ff !important; color: #0ff !important; box-shadow: 0 0 10px #0ff;
        }
        body.skin-neon .date-header { background-color: #000 !important; color: #0ff !important; border: 1px solid #0ff; }
        body.skin-neon #activity-log li { border: 1px solid #333; }

        /* --- SKIN 3: LUXURY (Gold) --- */
        body.skin-luxury {
            background-color: #1a1a1a !important;
            color: #d4af37 !important; /* Gold */
            font-family: 'Playfair Display', serif !important;
        }
        body.skin-luxury h1 { color: #d4af37 !important; text-transform: uppercase; letter-spacing: 2px; }
        body.skin-luxury .reel { border-color: #d4af37 !important; background-color: #222 !important; box-shadow: 0 10px 20px rgba(0,0,0,0.5) !important; }
        body.skin-luxury .reel-item { color: #d4af37 !important; border-bottom: 1px solid #444 !important; }
        body.skin-luxury .login-btn, body.skin-luxury .save-btn, body.skin-luxury .add-btn {
            background: linear-gradient(45deg, #d4af37, #a67c00) !important; color: #000 !important; border: none !important;
        }
        body.skin-luxury .date-header { background-color: #222 !important; color: #d4af37 !important; border: 1px solid #d4af37; }

        /* --- DARK MODE (System Default) --- */
        @media (prefers-color-scheme: dark) {
            body:not(.skin-neon):not(.skin-luxury) { background-color: #1e1e1e !important; color: #f4f4f9 !important; }
            body:not(.skin-neon):not(.skin-luxury) h1 { color: #f4f4f9 !important; }
            body:not(.skin-neon):not(.skin-luxury) #login-screen { background-color: #1e1e1e !important; }
            body:not(.skin-neon):not(.skin-luxury) .login-box { background-color: #2a2a2a !important; }
            body:not(.skin-neon):not(.skin-luxury) .login-input { background-color: #333 !important; color: #fff !important; border: 1px solid #555 !important; }
            body:not(.skin-neon):not(.skin-luxury) .reel { background-color: #333 !important; border: 3px solid #999 !important; }
            body:not(.skin-neon):not(.skin-luxury) .date-header { background-color: #555 !important; }
            body:not(.skin-neon):not(.skin-luxury) .color-8 { color: #333 !important; }
            body:not(.skin-neon):not(.skin-luxury) .settings-content { background-color: #2a2a2a !important; color: #fff !important; }
            body:not(.skin-neon):not(.skin-luxury) .setting-row input[type="text"] { background-color: #333 !important; color: #fff !important; }
        }

        /* SCREENS */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #fff; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #login-screen { display: none; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; width: 100%; }
        #app-screen { display: none; padding: 20px; }

        /* UI ELEMENTS */
        .login-box { padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 350px; width: 90%; background-color: #fff; display: flex; flex-direction: column; gap: 10px; }
        .login-input { width: 100%; padding: 12px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; display: block; }
        .login-btn, .google-btn, .save-btn, .logout-btn, .add-btn, .test-btn { width: 100%; padding: 12px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold; display: block; text-transform: uppercase; margin-top: 10px; }
        .login-btn, .save-btn { background-color: #2196F3 !important; color: white !important; }
        .google-btn { background-color: #DB4437 !important; color: white !important; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .logout-btn { background-color: #f44336 !important; color: white !important; margin-top: 20px; }
        .add-btn { background-color: #4CAF50 !important; color: white !important; width: auto; padding: 10px 20px; margin-top: 0; }
        .test-btn { background-color: #9C27B0 !important; color: white !important; margin-top: 30px; border: 2px dashed #ccc; }
        #toggle-auth { margin-top: 20px; color: #2196F3; cursor: pointer; font-size: 14px; text-decoration: underline; }
        #auth-error { color: #f44336; margin-top: 15px; font-size: 14px; font-weight: bold; background: rgba(255, 0, 0, 0.1); padding: 5px; border-radius: 4px; display: none; }
        
        /* REEL & LOG */
        #settings-btn { position: fixed; top: 15px; right: 15px; font-size: 24px; background: none; border: none; cursor: pointer; z-index: 2000; }
        #profile-btn { position: fixed; top: 15px; left: 15px; font-size: 24px; background: none; border: none; cursor: pointer; z-index: 2000; }
        #slot-container { display: flex; justify-content: center; align-items: center; margin: 30px auto; }
        .reel { width: 250px; height: 50px; border: 3px solid #666; border-radius: 10px; overflow: hidden; position: relative; cursor: grab; box-shadow: 0 5px 15px rgba(0,0,0,0.2); touch-action: none; background-color: #fff; -webkit-user-select: none; user-select: none; }
        .reel-items { position: absolute; width: 100%; display: flex; flex-direction: column; transform: translateY(0); transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .reel-item { height: 50px !important; min-height: 50px !important; display: flex; justify-content: center; align-items: center; font-size: 18px; font-weight: bold; color: #333; text-shadow: none; border-bottom: 1px solid rgba(0,0,0,0.1); box-sizing: border-box; -webkit-user-select: none; user-select: none; }
        .active-activity { box-shadow: 0 0 20px 5px rgba(255, 165, 0, 0.9); }
        #log-container { margin-top: 40px; padding: 0 20px 20px 20px; }
        #log-container h2 { display: none; }
        #activity-log { list-style: none; padding: 0; margin: 0 auto; max-width: 300px; text-align: center; }
        #activity-log li { list-style: none; padding: 10px; margin-bottom: 8px; border-radius: 4px; color: #fff; font-weight: 500; text-align: center; word-break: break-word; }
        .date-header { background-color: #e0e0e0 !important; color: #333 !important; margin: 25px auto 10px auto !important; padding: 5px 10px !important; border-radius: 20px; display: inline-block; font-size: 0.9em; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        
        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 3000; overflow-y: auto; }
        .settings-content { background-color: #fff; margin: 20px auto; padding: 20px; width: 90%; max-width: 400px; border-radius: 10px; text-align: left; display: flex; flex-direction: column; gap: 10px;}
        .setting-row { display: flex; align-items: center; margin-bottom: 10px; gap: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .setting-row input[type="text"] { flex-grow: 1; padding: 5px; font-size: 16px; }
        .setting-row input[type="color"] { width: 40px; height: 40px; border: none; cursor: pointer; background: none; }
        .label-small { font-size: 10px; color: #666; text-align: center; width: 40px; }
        .add-row { display: flex; gap: 10px; margin-top: 20px; padding-top: 10px; border-top: 1px dashed #ccc; align-items: center; }
        .add-row input[type="text"] { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .close-modal { align-self: flex-end; font-size: 24px; cursor: pointer; color: #666; margin-bottom: 10px; }
        .profile-pic { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 0 auto 10px auto; border: 3px solid #2196F3; display: block; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="spinner"></div>
        <p id="loading-text">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</p>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <h2 id="auth-title">–í—Ö–æ–¥ –≤ –ê–∫—Ç–∏–≤–µ–Ω –î–Ω–µ–≤–Ω–∏–∫</h2>
            <input type="email" id="auth-email" class="login-input" placeholder="–ò–º–µ–π–ª –∞–¥—Ä–µ—Å" autocomplete="email">
            <input type="password" id="auth-password" class="login-input" placeholder="–ü–∞—Ä–æ–ª–∞" autocomplete="current-password">
            <button id="btn-email-auth" class="login-btn">–í–•–û–î</button>
            <button id="btn-google-auth" class="google-btn"><i class="fa fa-google"></i> –í–•–û–î —Å Google</button>
            <p id="toggle-auth">–ù—è–º–∞—à –∞–∫–∞—É–Ω—Ç? –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ.</p>
            <p id="auth-error"></p>
        </div>
    </div>
    
    <div id="app-screen">
        <button id="profile-btn">üë§</button> 
        <button id="settings-btn">‚öôÔ∏è</button> 
        
        <div id="settings-modal" class="modal">
            <div class="settings-content">
                <span class="close-modal" onclick="document.getElementById('settings-modal').style.display='none'">&times;</span>
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                
                <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ccc;">
                    <label>üé® –î–∏–∑–∞–π–Ω:</label>
                    <select id="skin-selector" style="width:100%; padding:8px; margin-top:5px; border-radius:5px;">
                        <option value="skin-default">–°—Ç–∞–Ω–¥–∞—Ä—Ç–µ–Ω (–°–≤–µ—Ç—ä–ª/–¢—ä–º–µ–Ω)</option>
                        <option value="skin-neon">Neon Cyberpunk</option>
                        <option value="skin-luxury">Luxury Gold</option>
                    </select>
                </div>

                <div id="settings-list"></div>
                <div class="add-row">
                    <input type="text" id="new-activity-name" placeholder="–ò–º–µ –Ω–∞ –Ω–æ–≤–∞ –¥–µ–π–Ω–æ—Å—Ç">
                    <button id="btn-add-activity" class="add-btn">‚ûï</button>
                </div>
                <button id="btn-save-settings" class="save-btn">–ó–ê–ü–ê–ó–ò –ü–†–û–ú–ï–ù–ò–¢–ï</button>
                <hr style="margin-top: 20px; border-top: 1px dashed #ccc;">
                <button id="btn-generate-test" class="test-btn">üß™ –ì–µ–Ω–µ—Ä–∏—Ä–∞–π –¢–µ—Å—Ç–æ–≤–∏ –î–∞–Ω–Ω–∏</button>
            </div>
        </div>

        <div id="profile-modal" class="modal">
            <div class="settings-content">
                <span class="close-modal" onclick="document.getElementById('profile-modal').style.display='none'">&times;</span>
                <h2>–ú–æ—è—Ç –ü—Ä–æ—Ñ–∏–ª</h2>
                <img id="user-avatar" src="" alt="Profile" class="profile-pic">
                <p style="text-align: center; margin-bottom: 5px;">–í–ª–µ–∑–ª–∏ —Å—Ç–µ –∫–∞—Ç–æ:</p>
                <p id="user-email-display" style="font-weight: bold; margin-bottom: 20px; word-break: break-all; text-align: center; font-size: 18px;"></p>
                <hr style="width:100%; border:0; border-top:1px solid #eee;">
                <h3>–°–º—è–Ω–∞ –Ω–∞ –ø–∞—Ä–æ–ª–∞</h3>
                <input type="password" id="new-password-input" class="login-input" placeholder="–ù–æ–≤–∞ –ø–∞—Ä–æ–ª–∞">
                <button id="btn-change-password" class="save-btn" style="background-color: #FF9800 !important;">–°–ú–ï–ù–ò –ü–ê–†–û–õ–ê</button>
                <hr style="width:100%; border:0; border-top:1px solid #eee; margin-top: 20px;">
                <button id="btn-logout-action" class="logout-btn">–ò–ó–•–û–î</button>
            </div>
        </div>

        <div>
            <h1>–ê–∫—Ç–∏–≤–µ–Ω –î–Ω–µ–≤–Ω–∏–∫</h1>
            <div id="slot-container">
                <div id="main-reel" class="reel">
                    <div id="reel-items" class="reel-items"></div>
                </div>
            </div>
            <div id="current-activity-display" style="text-align: center; margin-top: 20px; font-size: 16px; font-weight: bold; color: #555;"></div>
        </div>
        <div id="log-container">
            <h2>–õ–æ–≥</h2>
            <ul id="activity-log"></ul>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDPzM2ncCIX43TgcSOym51kUQIPZVH2w84",
            authDomain: "daily-routine-f3688.firebaseapp.com",
            projectId: "daily-routine-f3688",
            storageBucket: "daily-routine-f3688.firebasestorage.app",
            messagingSenderId: "119560133908",
            appId: "1:119560133908:web:9bce81885e2df34434b601",
            measurementId: "G-BQCYBB91KR"
        };

        try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error(e); }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const usersCollection = db.collection('users');

        let defaultActivities = [
            { name: '–°—Ç–∞–≤–∞–Ω–µ', bg: '#e57373', text: '#ffffff' }, { name: '–õ—è–≥–∞–Ω–µ', bg: '#64b5f6', text: '#ffffff' }, { name: '–û–±—è–¥', bg: '#81c784', text: '#ffffff' }, { name: '–ó–∞–∫—É—Å–∫–∞', bg: '#ffb74d', text: '#ffffff' }, { name: '–í–µ—á–µ—Ä—è', bg: '#ba68c8', text: '#ffffff' }, { name: '–§–∏–ª–º–∏', bg: '#4db6ac', text: '#ffffff' }, { name: '–§–∏—Ç–Ω–µ—Å', bg: '#ff8a65', text: '#ffffff' }, { name: '–†–∞–±–æ—Ç–∞', bg: '#a1887f', text: '#ffffff' }, { name: '–ß–µ—Ç–µ–Ω–µ', bg: '#fff176', text: '#333333' }, { name: '–ü–æ—á–∏–≤–∫–∞', bg: '#90a4ae', text: '#ffffff' }
        ];
        let activities = JSON.parse(JSON.stringify(defaultActivities));
        let activityData = []; 
        let activeActivity = null; 
        let currentUserID = null; 
        let currentSkin = 'skin-default';
        const itemHeight = 50; 
        let isLoginMode = true; 
        let isDragging = false; 
        let startY = 0;
        let currentTranslateY = 0;
        let pressTimer = null;

        // --- SKIN FUNCTION ---
        function changeSkin(skinName) {
            document.body.className = skinName;
            currentSkin = skinName;
            document.getElementById('skin-selector').value = skinName;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const loadingScreen = document.getElementById('loading-screen');
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app-screen');
            
            // Safety Timeout
            setTimeout(() => {
                if (loadingScreen.style.display !== 'none' && !currentUserID) {
                    loadingScreen.style.display = 'none';
                    loginScreen.style.display = 'flex';
                }
            }, 4000);

            // Elements
            const authTitle = document.getElementById('auth-title');
            const authError = document.getElementById('auth-error');
            const authEmail = document.getElementById('auth-email');
            const authPassword = document.getElementById('auth-password');
            const btnEmailAuth = document.getElementById('btn-email-auth');
            const btnGoogleAuth = document.getElementById('btn-google-auth');
            const toggleAuthBtn = document.getElementById('toggle-auth');
            const profileBtn = document.getElementById('profile-btn');
            const profileModal = document.getElementById('profile-modal');
            const userEmailDisplay = document.getElementById('user-email-display');
            const userAvatar = document.getElementById('user-avatar');
            const btnChangePassword = document.getElementById('btn-change-password');
            const btnLogoutAction = document.getElementById('btn-logout-action');
            const newPasswordInput = document.getElementById('new-password-input');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const btnSaveSettings = document.getElementById('btn-save-settings');
            const btnAddActivity = document.getElementById('btn-add-activity');
            const btnGenerateTest = document.getElementById('btn-generate-test');
            const mainReel = document.getElementById('main-reel');
            const skinSelector = document.getElementById('skin-selector');

            loginScreen.style.display = 'flex'; 

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    loadingScreen.style.display = 'flex'; 
                    currentUserID = user.uid;
                    userEmailDisplay.textContent = user.email || "Google User";
                    userAvatar.src = user.photoURL || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
                    
                    await loadState();
                    renderLog();
                    updateDisplay(0);
                    
                    loadingScreen.style.display = 'none';
                    loginScreen.style.display = 'none';
                    appScreen.style.display = 'block';
                } else {
                    currentUserID = null;
                    loadingScreen.style.display = 'none';
                    appScreen.style.display = 'none';
                    loginScreen.style.display = 'flex';
                }
            });

            // UI Handlers
            skinSelector.addEventListener('change', (e) => changeSkin(e.target.value));

            toggleAuthBtn.addEventListener('click', () => {
                isLoginMode = !isLoginMode;
                authError.style.display = 'none';
                authTitle.textContent = isLoginMode ? '–í—Ö–æ–¥ –≤ –ê–∫—Ç–∏–≤–µ–Ω –î–Ω–µ–≤–Ω–∏–∫' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
                toggleAuthBtn.textContent = isLoginMode ? '–ù—è–º–∞—à –∞–∫–∞—É–Ω—Ç? –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ.' : '–ò–º–∞—à –∞–∫–∞—É–Ω—Ç? –í–ª–µ–∑.';
                btnEmailAuth.textContent = isLoginMode ? '–í–•–û–î' : '–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø';
            });
            btnEmailAuth.addEventListener('click', async () => {
                const email = authEmail.value; const password = authPassword.value;
                authError.style.display = 'none';
                if (email.length < 5 || password.length < 6) { authError.textContent = '–ú–∏–Ω. 6 —Å–∏–º–≤–æ–ª–∞.'; authError.style.display = 'block'; return; }
                loadingScreen.style.display = 'flex';
                try {
                    if (isLoginMode) await auth.signInWithEmailAndPassword(email, password);
                    else await auth.createUserWithEmailAndPassword(email, password);
                } catch (error) {
                    loadingScreen.style.display = 'none';
                    authError.textContent = error.message;
                    authError.style.display = 'block';
                }
            });
            btnGoogleAuth.addEventListener('click', async () => {
                authError.style.display = 'none';
                const provider = new firebase.auth.GoogleAuthProvider();
                try { await auth.signInWithPopup(provider); } catch (error) { authError.textContent = error.message; authError.style.display = 'block'; }
            });
            profileBtn.addEventListener('click', () => { profileModal.style.display = 'block'; newPasswordInput.value = ''; });
            btnLogoutAction.addEventListener('click', () => { profileModal.style.display = 'none'; auth.signOut(); });
            btnChangePassword.addEventListener('click', () => {
                if (newPasswordInput.value.length < 6) return alert("–ú–∏–Ω 6 —Å–∏–º–≤–æ–ª–∞.");
                auth.currentUser.updatePassword(newPasswordInput.value).then(() => { alert("–°–º–µ–Ω–µ–Ω–∞!"); newPasswordInput.value=''; }).catch(e => alert(e.message));
            });
            settingsBtn.addEventListener('click', () => { generateSettingsList(); settingsModal.style.display = 'block'; });
            btnSaveSettings.addEventListener('click', saveAndCloseSettings);
            btnAddActivity.addEventListener('click', () => {
                const input = document.getElementById('new-activity-name');
                if (input.value.trim()) { activities.push({ name: input.value.trim(), bg: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0'), text: '#ffffff' }); generateSettingsList(); input.value = ''; }
            });
            
            btnGenerateTest.addEventListener('click', () => {
                if(confirm("–í–ù–ò–ú–ê–ù–ò–ï: –¢–æ–≤–∞ —â–µ –∏–∑—Ç—Ä–∏–µ —Ç–µ–∫—É—â–∏—è –ª–æ–≥ –∏ —â–µ –≥–µ–Ω–µ—Ä–∏—Ä–∞ –¥–∞–Ω–Ω–∏ –∑–∞ 3 –¥–Ω–∏ –Ω–∞–∑–∞–¥. –ü—Ä–æ–¥—ä–ª–∂–∏?")) {
                    generateTestData();
                    settingsModal.style.display = 'none';
                }
            });

            mainReel.addEventListener('contextmenu', (e) => e.preventDefault());
            mainReel.addEventListener('touchstart', handleTouchStart);
            mainReel.addEventListener('touchmove', handleTouchMove);
            mainReel.addEventListener('touchend', handleTouchEnd);

            function generateSettingsList() {
                const list = document.getElementById('settings-list'); list.innerHTML = '';
                activities.forEach((act, index) => {
                    const row = document.createElement('div'); row.className = 'setting-row';
                    row.innerHTML = `<div><input type="color" id="bg-${index}" value="${act.bg}"><br><small>–§–æ–Ω</small></div><div><input type="color" id="txt-${index}" value="${act.text}"><br><small>–¢–µ–∫—Å—Ç</small></div><input type="text" id="name-${index}" value="${act.name}"><button class="delete-btn" onclick="removeActivity(${index})">[X]</button>`;
                    list.appendChild(row);
                });
            }
            window.removeActivity = (i) => { if(activities.length>1 && confirm('–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?')) { activities.splice(i,1); generateSettingsList(); }};
            function saveAndCloseSettings() {
                for(let i=0; i<activities.length; i++) {
                    const n = document.getElementById(`name-${i}`)?.value;
                    const b = document.getElementById(`bg-${i}`)?.value;
                    const t = document.getElementById(`txt-${i}`)?.value;
                    if(n) activities[i] = {name:n, bg:b, text:t};
                }
                if(activeActivity && activeActivity.colorIndex >= activities.length) activeActivity=null;
                saveState(); generateReelContent(); renderLog(); updateDisplay(getCurrentTransformY());
                settingsModal.style.display='none';
            }
            async function saveState() { if(!currentUserID) return; try{ await usersCollection.doc(currentUserID).set({activities, activityLog:activityData, activeActivity, skin:currentSkin, lastLogDate:new Date().toISOString().slice(0,10)}, {merge:true}); }catch(e){console.error(e);} }
            async function loadState() {
                if(!currentUserID) return;
                try {
                    const doc = await usersCollection.doc(currentUserID).get();
                    if(doc.exists) {
                        const d = doc.data();
                        if(d.activities) activities = d.activities;
                        if(d.skin) changeSkin(d.skin);
                        
                        // –ó–∞—Ä–µ–∂–¥–∞–º–µ –¥–∞–Ω–Ω–∏—Ç–µ –≤–∏–Ω–∞–≥–∏, –∑–∞ —Ç–µ—Å—Ç
                        activityData = d.activityLog || [];
                        activeActivity = d.activeActivity || null;
                    }
                } catch(e){console.error(e);}
                generateReelContent();
            }
            function generateReelContent() {
                const ri = document.getElementById('reel-items'); ri.innerHTML='';
                activities.forEach((act, i) => { const d=document.createElement('div'); d.className='reel-item'; d.textContent=act.name; d.style.backgroundColor=act.bg; d.style.color=act.text; ri.appendChild(d); });
            }
            
            function renderLog() {
                const l = document.getElementById('activity-log'); l.innerHTML='';
                if(activeActivity) { const li=document.createElement('li'); const a=activities[activeActivity.colorIndex]||{bg:'#ccc',text:'#000'}; li.style.backgroundColor=a.bg; li.style.color=a.text; li.textContent=`–ó–ê–ü–û–ß–ù–ê–¢–û: ${activeActivity.name} –≤ ${new Date(activeActivity.startTime).toLocaleTimeString()}`; l.appendChild(li); }
                
                const sortedData = [...activityData].sort((a,b) => new Date(b.startTime) - new Date(a.startTime));
                let currentHeaderDate = '';

                sortedData.forEach(e => {
                    const startTime = new Date(e.startTime);
                    const dateOptions = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
                    let dateStr = startTime.toLocaleDateString('bg-BG', dateOptions);
                    dateStr = dateStr.charAt(0).toUpperCase() + dateStr.slice(1); 

                    if (dateStr !== currentHeaderDate) {
                        const headerLi = document.createElement('li');
                        headerLi.className = 'date-header';
                        headerLi.textContent = dateStr;
                        l.appendChild(headerLi);
                        currentHeaderDate = dateStr;
                    }

                    const li=document.createElement('li'); const a=activities[e.colorIndex]||{bg:'#ccc',text:'#000'}; li.style.backgroundColor=a.bg; li.style.color=a.text;
                    const dur=Math.floor((new Date(e.endTime)-new Date(e.startTime))/1000);
                    const h=Math.floor(dur/3600), m=Math.floor((dur%3600)/60), s=dur%60;
                    li.textContent=`${e.name}: ${new Date(e.startTime).toLocaleTimeString()} - ${new Date(e.endTime).toLocaleTimeString()} | ${(h>0?h+'—á ':'')+(m>0?m+'–º–∏–Ω ':'')+s+'—Å–µ–∫'}`; 
                    l.appendChild(li);
                });
            }
            
            function getCurrentTransformY() { return new WebKitCSSMatrix(window.getComputedStyle(document.getElementById('reel-items')).transform).m42; }
            function updateDisplay(y) {
                const i = Math.abs(Math.round(y/50));
                if(i<activities.length) {
                    const a=activities[i];
                    document.getElementById('main-reel').classList.toggle('active-activity', !!(auth.currentUser && activeActivity));
                    document.getElementById('current-activity-display').innerHTML = `–ò–∑–±—Ä–∞–Ω–∞: <span style="padding:2px 5px;border-radius:4px;background-color:${a.bg};color:${a.text}">${a.name}</span>. –î–æ–∫–æ—Å–Ω–µ—Ç–µ –∑–∞ —Å—Ç–∞—Ä—Ç.`;
                }
            }
            function snapToClosestItem() {
                let y=getCurrentTransformY(); let f=Math.max(-(activities.length-1)*50, Math.min(0, Math.round(y/50)*50));
                document.getElementById('reel-items').style.transform=`translateY(${f}px)`; currentTranslateY=f; updateDisplay(f);
            }
            function handleTap() {
                if(!currentUserID) return alert("–ú–æ–ª—è, –≤–ª–µ–∑—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª–∞ —Å–∏!");
                snapToClosestItem();
                const i=Math.abs(Math.round(getCurrentTransformY()/50)); if(i>=activities.length) return;
                const n=activities[i].name, now=new Date().toISOString();
                if(activeActivity && activeActivity.colorIndex===i) return;
                if(activeActivity) activityData.push({name:activeActivity.name, colorIndex:activeActivity.colorIndex, startTime:activeActivity.startTime, endTime:now});
                activeActivity={name:n, startTime:now, colorIndex:i}; renderLog(); saveState();
            }
            function handleTouchStart(e) { isDragging=false; startY=e.touches[0].clientY; currentTranslateY=getCurrentTransformY(); document.getElementById('reel-items').style.transition='none'; pressTimer=setTimeout(()=>{if(!isDragging){const i=Math.abs(Math.round(currentTranslateY/50)); const nn=prompt("–†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ:",activities[i].name); if(nn){activities[i].name=nn;generateReelContent();saveState();updateDisplay(currentTranslateY);}}},700); }
            function handleTouchMove(e) { const dy=e.touches[0].clientY-startY; if(Math.abs(dy)>5){isDragging=true;clearTimeout(pressTimer);} const ny=Math.max(-(activities.length-1)*50, Math.min(0, currentTranslateY+dy)); document.getElementById('reel-items').style.transform=`translateY(${ny}px)`; }
            function handleTouchEnd() { clearTimeout(pressTimer); document.getElementById('reel-items').style.transition='transform 0.2s ease-out'; if(isDragging) snapToClosestItem(); else handleTap(); isDragging=false; }

            window.generateTestData = function() {
                activityData = [];
                activeActivity = null;
                const now = new Date();
                for (let i = 0; i < 3; i++) {
                    let day = new Date(now); day.setDate(day.getDate() - i);
                    let start1 = new Date(day); start1.setHours(8,0,0); let end1 = new Date(day); end1.setHours(9,0,0);
                    activityData.push({ name: "–ó–∞–∫—É—Å–∫–∞", colorIndex: 3, startTime: start1.toISOString(), endTime: end1.toISOString() });
                    let start2 = new Date(day); start2.setHours(9,0,0); let end2 = new Date(day); end2.setHours(17,0,0);
                    activityData.push({ name: "–†–∞–±–æ—Ç–∞", colorIndex: 7, startTime: start2.toISOString(), endTime: end2.toISOString() });
                    let start3 = new Date(day); start3.setHours(18,0,0); let end3 = new Date(day); end3.setHours(19,30,0);
                    activityData.push({ name: "–§–∏—Ç–Ω–µ—Å", colorIndex: 6, startTime: start3.toISOString(), endTime: end3.toISOString() });
                }
                renderLog(); saveState(); alert("–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∏ –¥–∞–Ω–Ω–∏ –∑–∞ 3 –¥–Ω–∏!");
            };
        });
    </script>
</body>
</html>
