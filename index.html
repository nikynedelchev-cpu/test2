<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–∫—Ç–∏–≤–µ–Ω –î–Ω–µ–≤–Ω–∏–∫</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Orbitron:wght@500&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS VARIABLES (THEMING ENGINE) --- */
        :root {
            /* Default (Skin 1) */
            --bg-body: #f4f4f9;
            --text-main: #333;
            --reel-bg: #fff;
            --reel-border: #ccc;
            --reel-shadow: 0 5px 15px rgba(0,0,0,0.1);
            --btn-primary: #2196F3;
            --btn-text: #fff;
            --modal-bg: #fff;
            --input-bg: #fff;
            --input-border: #ccc;
            --font-main: 'Roboto', sans-serif;
            --active-glow: 0 0 15px rgba(33, 150, 243, 0.5);
            --date-header-bg: #e0e0e0;
            --date-header-text: #333;
        }

        /* SKIN 2: NEON CYBERPUNK */
        body.skin-neon {
            --bg-body: #0b0c15;
            --text-main: #0ff;
            --reel-bg: #111;
            --reel-border: #0ff;
            --reel-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            --btn-primary: #ff0055;
            --btn-text: #fff;
            --modal-bg: #1a1a24;
            --input-bg: #0b0c15;
            --input-border: #0ff;
            --font-main: 'Orbitron', sans-serif; /* –§—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ–Ω —à—Ä–∏—Ñ—Ç */
            --active-glow: 0 0 25px #0ff, 0 0 10px #0ff inset;
            --date-header-bg: #ff0055;
            --date-header-text: #fff;
        }

        /* SKIN 3: LUXURY DARK */
        body.skin-luxury {
            --bg-body: #121212;
            --text-main: #d4af37; /* –ó–ª–∞—Ç–∏—Å—Ç–æ */
            --reel-bg: #1e1e1e;
            --reel-border: #d4af37;
            --reel-shadow: 0 10px 30px rgba(0,0,0,0.5);
            --btn-primary: linear-gradient(45deg, #d4af37, #c5a028);
            --btn-text: #000;
            --modal-bg: #1e1e1e;
            --input-bg: #2c2c2c;
            --input-border: #555;
            --font-main: 'Playfair Display', serif; /* –ï–ª–µ–≥–∞–Ω—Ç–µ–Ω —à—Ä–∏—Ñ—Ç */
            --active-glow: 0 0 20px rgba(212, 175, 55, 0.4);
            --date-header-bg: #2c2c2c;
            --date-header-text: #d4af37;
        }

        /* --- GLOBAL STYLES --- */
        html, body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font-main);
            margin: 0; padding: 0; min-height: 100vh;
            transition: background-color 0.3s, color 0.3s; /* –ü–ª–∞–≤–µ–Ω –ø—Ä–µ—Ö–æ–¥ –ø—Ä–∏ —Å–º—è–Ω–∞ */
            text-align: center;
        }

        h1 { margin-top: 0; letter-spacing: 1px; }

        /* --- COMPONENTS --- */
        
        /* Buttons */
        button { font-family: var(--font-main); transition: transform 0.1s; }
        button:active { transform: scale(0.96); }
        
        #settings-btn, #profile-btn {
            position: fixed; top: 15px; font-size: 24px; background: none; border: none; cursor: pointer; z-index: 2000;
            color: var(--text-main); filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
        }
        #settings-btn { right: 15px; }
        #profile-btn { left: 15px; }

        /* Reel */
        #slot-container { display: flex; justify-content: center; align-items: center; margin: 30px auto; perspective: 1000px; }
        .reel {
            width: 260px; height: 60px; /* –ú–∞–ª–∫–æ –ø–æ-–≥–æ–ª—è–º–∞ */
            border: 2px solid var(--reel-border);
            border-radius: 15px;
            overflow: hidden; position: relative; cursor: grab;
            box-shadow: var(--reel-shadow);
            background-color: var(--reel-bg);
            touch-action: none; -webkit-user-select: none; user-select: none;
        }
        .reel.active-activity {
            box-shadow: var(--active-glow);
            border-color: var(--btn-primary);
        }
        
        .reel-items { position: absolute; width: 100%; display: flex; flex-direction: column; transform: translateY(0); transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .reel-item {
            height: 60px !important; min-height: 60px !important; /* –ü–æ-–≤–∏—Å–æ–∫–∏ —Ä–µ–¥–æ–≤–µ */
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; font-weight: bold;
            color: #333; /* –¢–µ–∫—Å—Ç—ä—Ç –≤—ä—Ç—Ä–µ –≤ —Ü–≤–µ—Ç–Ω–∏—Ç–µ –±–ª–æ–∫–æ–≤–µ –≤–∏–Ω–∞–≥–∏ –µ —Ç—ä–º–µ–Ω –∏–ª–∏ –±—è–ª —Å–ø–æ—Ä–µ–¥ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ç–∞ */
            text-shadow: none;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-sizing: border-box;
        }

        /* Display Text */
        #current-activity-display {
            margin-top: 25px; font-size: 18px; font-weight: bold; color: var(--text-main);
        }

        /* Log */
        #log-container { margin-top: 40px; padding: 0 20px 80px 20px; }
        #activity-log { list-style: none; padding: 0; margin: 0 auto; max-width: 320px; }
        #activity-log li {
            padding: 12px; margin-bottom: 10px; border-radius: 8px;
            font-weight: 500; font-size: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: #fff; /* –¢–µ–∫—Å—Ç –≤ –±–∞–ª–æ–Ω—á–µ—Ç–∞—Ç–∞ */
        }
        .date-header {
            background: var(--date-header-bg) !important;
            color: var(--date-header-text) !important;
            display: inline-block; padding: 6px 15px !important;
            border-radius: 20px; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px;
            margin: 25px auto 10px auto !important;
            box-shadow: none !important;
            border: 1px solid var(--reel-border);
        }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); z-index: 3000; backdrop-filter: blur(5px); }
        .settings-content {
            background-color: var(--modal-bg); color: var(--text-main);
            margin: 10vh auto; padding: 25px; width: 85%; max-width: 400px;
            border-radius: 20px; text-align: left;
            border: 1px solid var(--reel-border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-height: 80vh; overflow-y: auto;
        }
        .close-modal { float: right; font-size: 28px; cursor: pointer; color: var(--text-main); }
        
        /* Inputs & Controls */
        input[type="text"], input[type="password"], input[type="email"], select {
            width: 100%; padding: 12px; margin: 5px 0;
            background-color: var(--input-bg); color: var(--text-main);
            border: 1px solid var(--input-border); border-radius: 8px;
            font-family: var(--font-main); font-size: 16px;
            box-sizing: border-box;
        }
        
        .setting-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; border-bottom: 1px solid var(--input-border); padding-bottom: 8px; }
        .setting-row input[type="color"] { width: 35px; height: 35px; border: none; background: none; cursor: pointer; }
        
        .save-btn, .login-btn, .add-btn, .google-btn {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            background: var(--btn-primary); color: var(--btn-text);
            margin-top: 15px; text-transform: uppercase; letter-spacing: 1px;
        }
        
        .google-btn { background: #DB4437 !important; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .delete-btn { background: #ff4444; color: white; border: none; border-radius: 5px; width: 30px; height: 30px; font-weight: bold; cursor: pointer; }
        .test-btn { background: transparent; border: 1px dashed var(--text-main); color: var(--text-main); margin-top: 20px; width: 100%; padding: 10px; cursor: pointer; opacity: 0.7; }

        /* Login Specific */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; background-color: var(--bg-body); }
        .login-box { background-color: var(--modal-bg); padding: 40px; border-radius: 20px; box-shadow: var(--reel-shadow); border: 1px solid var(--reel-border); width: 90%; max-width: 350px; }
        
        #loading-screen { background-color: var(--bg-body); color: var(--text-main); position: fixed; top:0; left:0; width:100%; height:100%; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid var(--btn-primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }

        /* Profile Pic */
        .profile-pic { width: 90px; height: 90px; border-radius: 50%; margin: 0 auto 15px auto; display: block; border: 3px solid var(--btn-primary); object-fit: cover; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="spinner"></div>
        <p>–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</p>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <h2 id="auth-title">–í–•–û–î</h2>
            <input type="email" id="auth-email" placeholder="–ò–º–µ–π–ª">
            <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª–∞">
            <button id="btn-email-auth" class="login-btn">–í–ª–µ–∑</button>
            <button id="btn-google-auth" class="google-btn"><i class="fa fa-google"></i> Google</button>
            <p id="toggle-auth" style="margin-top:20px; cursor:pointer; text-decoration:underline; color:var(--btn-primary);">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</p>
            <p id="auth-error" style="color:red; display:none; margin-top:10px;"></p>
        </div>
    </div>
    
    <div id="app-screen">
        <button id="profile-btn">üë§</button> 
        <button id="settings-btn">‚öôÔ∏è</button> 
        
        <div id="settings-modal" class="modal">
            <div class="settings-content">
                <span class="close-modal" onclick="document.getElementById('settings-modal').style.display='none'">&times;</span>
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                
                <div style="margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 15px;">
                    <label style="font-weight:bold;">üé® –î–∏–∑–∞–π–Ω (Skin):</label>
                    <select id="skin-selector" onchange="changeSkin(this.value)">
                        <option value="skin-default">Skin 1: –ß–∏—Å—Ç (–°–≤–µ—Ç—ä–ª)</option>
                        <option value="skin-neon">Skin 2: –ù–µ–æ–Ω (Cyberpunk)</option>
                        <option value="skin-luxury">Skin 3: –õ—É–∫—Å (–¢—ä–º–µ–Ω)</option>
                    </select>
                </div>

                <div id="settings-list"></div>
                <div class="add-row">
                    <input type="text" id="new-activity-name" placeholder="–ù–æ–≤–∞ –¥–µ–π–Ω–æ—Å—Ç...">
                    <button id="btn-add-activity" class="add-btn" style="width:auto;">‚ûï</button>
                </div>
                <button id="btn-save-settings" class="save-btn">–ó–ê–ü–ê–ó–ò</button>
                <button id="btn-generate-test" class="test-btn">üß™ –¢–µ—Å—Ç–æ–≤–∏ –î–∞–Ω–Ω–∏</button>
            </div>
        </div>

        <div id="profile-modal" class="modal">
            <div class="settings-content">
                <span class="close-modal" onclick="document.getElementById('profile-modal').style.display='none'">&times;</span>
                <img id="user-avatar" src="" alt="Profile" class="profile-pic">
                <p id="user-email-display" style="text-align:center; font-weight:bold; margin-bottom:20px;"></p>
                <input type="password" id="new-password-input" placeholder="–ù–æ–≤–∞ –ø–∞—Ä–æ–ª–∞">
                <button id="btn-change-password" class="save-btn" style="background:#FF9800 !important">–°–º–µ–Ω–∏ –ü–∞—Ä–æ–ª–∞</button>
                <button id="btn-logout-action" class="logout-btn">–ò–ó–•–û–î</button>
            </div>
        </div>

        <div>
            <h1>–ê–∫—Ç–∏–≤–µ–Ω –î–Ω–µ–≤–Ω–∏–∫</h1>
            <div id="slot-container">
                <div id="main-reel" class="reel">
                    <div id="reel-items" class="reel-items"></div>
                </div>
            </div>
            <div id="current-activity-display"></div>
        </div>
        <div id="log-container">
            <ul id="activity-log"></ul>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDPzM2ncCIX43TgcSOym51kUQIPZVH2w84",
            authDomain: "daily-routine-f3688.firebaseapp.com",
            projectId: "daily-routine-f3688",
            storageBucket: "daily-routine-f3688.firebasestorage.app",
            messagingSenderId: "119560133908",
            appId: "1:119560133908:web:9bce81885e2df34434b601",
            measurementId: "G-BQCYBB91KR"
        };

        try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error(e); }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const usersCollection = db.collection('users');

        let defaultActivities = [
            { name: '–°—Ç–∞–≤–∞–Ω–µ', bg: '#e57373', text: '#ffffff' }, { name: '–õ—è–≥–∞–Ω–µ', bg: '#64b5f6', text: '#ffffff' }, { name: '–û–±—è–¥', bg: '#81c784', text: '#ffffff' }, { name: '–ó–∞–∫—É—Å–∫–∞', bg: '#ffb74d', text: '#ffffff' }, { name: '–í–µ—á–µ—Ä—è', bg: '#ba68c8', text: '#ffffff' }, { name: '–§–∏–ª–º–∏', bg: '#4db6ac', text: '#ffffff' }, { name: '–§–∏—Ç–Ω–µ—Å', bg: '#ff8a65', text: '#ffffff' }, { name: '–†–∞–±–æ—Ç–∞', bg: '#a1887f', text: '#ffffff' }, { name: '–ß–µ—Ç–µ–Ω–µ', bg: '#fff176', text: '#333333' }, { name: '–ü–æ—á–∏–≤–∫–∞', bg: '#90a4ae', text: '#ffffff' }
        ];
        let activities = JSON.parse(JSON.stringify(defaultActivities));
        let activityData = []; 
        let activeActivity = null; 
        let currentUserID = null; 
        let currentSkin = 'skin-default'; // Default skin
        const itemHeight = 60; // –£–≤–µ–ª–∏—á–µ–Ω–∞ –≤–∏—Å–æ—á–∏–Ω–∞ –∑–∞ –ø–æ-–¥–æ–±—ä—Ä –¥–∏–∑–∞–π–Ω
        let isLoginMode = true; 
        let isDragging = false; 
        let startY = 0;
        let currentTranslateY = 0;
        let pressTimer = null;

        // --- SKIN FUNCTION ---
        window.changeSkin = function(skinName) {
            document.body.className = skinName;
            currentSkin = skinName;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const loadingScreen = document.getElementById('loading-screen');
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app-screen');
            const authError = document.getElementById('auth-error');
            const skinSelector = document.getElementById('skin-selector');

            // Safety Timeout
            setTimeout(() => { if(loadingScreen.style.display !== 'none' && !currentUserID) { loadingScreen.style.display='none'; loginScreen.style.display='flex'; } }, 4000);

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    loadingScreen.style.display = 'flex';
                    currentUserID = user.uid;
                    document.getElementById('user-email-display').textContent = user.email || "User";
                    document.getElementById('user-avatar').src = user.photoURL || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
                    
                    await loadState();
                    renderLog();
                    updateDisplay(0);
                    
                    loadingScreen.style.display = 'none';
                    loginScreen.style.display = 'none';
                    appScreen.style.display = 'block';
                } else {
                    currentUserID = null;
                    loadingScreen.style.display = 'none';
                    appScreen.style.display = 'none';
                    loginScreen.style.display = 'flex';
                }
            });

            // UI Bindings
            document.getElementById('toggle-auth').onclick = () => {
                isLoginMode = !isLoginMode;
                document.getElementById('auth-title').textContent = isLoginMode ? '–í–•–û–î' : '–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø';
                document.getElementById('btn-email-auth').textContent = isLoginMode ? '–í–õ–ï–ó' : '–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø';
                document.getElementById('toggle-auth').textContent = isLoginMode ? '–ù—è–º–∞—à –∞–∫–∞—É–Ω—Ç? –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ.' : '–ò–º–∞—à –∞–∫–∞—É–Ω—Ç? –í–ª–µ–∑.';
            };

            document.getElementById('btn-email-auth').onclick = async () => {
                const e = document.getElementById('auth-email').value;
                const p = document.getElementById('auth-password').value;
                loadingScreen.style.display = 'flex';
                try {
                    if(isLoginMode) await auth.signInWithEmailAndPassword(e, p);
                    else await auth.createUserWithEmailAndPassword(e, p);
                } catch(err) {
                    loadingScreen.style.display = 'none';
                    authError.textContent = err.message;
                    authError.style.display = 'block';
                }
            };

            document.getElementById('btn-google-auth').onclick = async () => {
                try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } 
                catch(e) { alert(e.message); }
            };

            document.getElementById('btn-logout-action').onclick = () => auth.signOut();
            document.getElementById('profile-btn').onclick = () => document.getElementById('profile-modal').style.display = 'block';
            document.getElementById('settings-btn').onclick = () => { generateSettingsList(); document.getElementById('settings-modal').style.display = 'block'; };
            document.getElementById('btn-save-settings').onclick = saveAndCloseSettings;
            document.getElementById('btn-add-activity').onclick = () => {
                const inp = document.getElementById('new-activity-name');
                if(inp.value.trim()) { activities.push({name:inp.value.trim(), bg:'#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'), text:'#ffffff'}); generateSettingsList(); inp.value=''; }
            };
            document.getElementById('btn-generate-test').onclick = () => { if(confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ç–µ–∫—É—â–∏—è –ª–æ–≥?")) generateTestData(); };
            
            // Reel Events
            const mr = document.getElementById('main-reel');
            mr.addEventListener('contextmenu', e => e.preventDefault());
            mr.addEventListener('touchstart', handleTouchStart);
            mr.addEventListener('touchmove', handleTouchMove);
            mr.addEventListener('touchend', handleTouchEnd);

            // Logic
            function generateSettingsList() {
                const list = document.getElementById('settings-list'); list.innerHTML = '';
                // Set skin selector value
                skinSelector.value = currentSkin;
                
                activities.forEach((act, index) => {
                    const row = document.createElement('div'); row.className = 'setting-row';
                    row.innerHTML = `<div><input type="color" id="bg-${index}" value="${act.bg}"><br><small>–§–æ–Ω</small></div><div><input type="color" id="txt-${index}" value="${act.text}"><br><small>–¢–µ–∫—Å—Ç</small></div><input type="text" id="name-${index}" value="${act.name}"><button class="delete-btn" onclick="removeActivity(${index})">X</button>`;
                    list.appendChild(row);
                });
            }
            window.removeActivity = (i) => { if(activities.length>1 && confirm('–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?')) { activities.splice(i,1); generateSettingsList(); }};

            function saveAndCloseSettings() {
                for(let i=0; i<activities.length; i++) {
                    const n = document.getElementById(`name-${i}`)?.value;
                    const b = document.getElementById(`bg-${i}`)?.value;
                    const t = document.getElementById(`txt-${i}`)?.value;
                    if(n) activities[i] = {name:n, bg:b, text:t};
                }
                if(activeActivity && activeActivity.colorIndex >= activities.length) activeActivity=null;
                saveState(); generateReelContent(); renderLog(); updateDisplay(getCurrentTransformY());
                document.getElementById('settings-modal').style.display='none';
            }

            async function saveState() {
                if(!currentUserID) return;
                try { await usersCollection.doc(currentUserID).set({
                    activities, activityLog:activityData, activeActivity, 
                    skin: currentSkin, // –ó–ê–ü–ê–ó–í–ê–ú–ï –ò–ó–ë–†–ê–ù–ò–Ø –°–ö–ò–ù
                    lastLogDate:new Date().toISOString().slice(0,10)
                }, {merge:true}); } catch(e){console.error(e);}
            }

            async function loadState() {
                if(!currentUserID) return;
                try {
                    const doc = await usersCollection.doc(currentUserID).get();
                    if(doc.exists) {
                        const d = doc.data();
                        if(d.activities) activities = d.activities;
                        if(d.skin) changeSkin(d.skin); // –ó–ê–†–ï–ñ–î–ê–ú–ï –°–ö–ò–ù–ê
                        
                        if(d.lastLogDate === new Date().toISOString().slice(0,10)) { 
                            activityData = d.activityLog||[]; activeActivity = d.activeActivity||null; 
                        } else { 
                            activityData=[]; activeActivity=null; 
                        }
                    }
                } catch(e){console.error(e);}
                generateReelContent();
            }

            function generateReelContent() {
                const ri = document.getElementById('reel-items'); ri.innerHTML='';
                activities.forEach((act, i) => { const d=document.createElement('div'); d.className='reel-item'; d.textContent=act.name; d.style.backgroundColor=act.bg; d.style.color=act.text; ri.appendChild(d); });
            }

            function renderLog() {
                const l = document.getElementById('activity-log'); l.innerHTML='';
                if(activeActivity) { const li=document.createElement('li'); const a=activities[activeActivity.colorIndex]||{bg:'#ccc',text:'#000'}; li.style.backgroundColor=a.bg; li.style.color=a.text; li.textContent=`–ó–ê–ü–û–ß–ù–ê–¢–û: ${activeActivity.name} –≤ ${new Date(activeActivity.startTime).toLocaleTimeString()}`; l.appendChild(li); }
                
                const sorted = [...activityData].sort((a,b) => new Date(b.startTime) - new Date(a.startTime));
                let curDate = '';
                sorted.forEach(e => {
                    const d = new Date(e.startTime);
                    const dStr = d.toLocaleDateString('bg-BG',{weekday:'long',day:'numeric',month:'long'});
                    if(dStr !== curDate) {
                        const h = document.createElement('li'); h.className='date-header'; h.textContent=dStr.charAt(0).toUpperCase()+dStr.slice(1);
                        l.appendChild(h); curDate=dStr;
                    }
                    const li=document.createElement('li'); const a=activities[e.colorIndex]||{bg:'#ccc',text:'#000'}; li.style.backgroundColor=a.bg; li.style.color=a.text;
                    const dur=Math.floor((new Date(e.endTime)-d)/1000);
                    const hrs=Math.floor(dur/3600), mins=Math.floor((dur%3600)/60), secs=dur%60;
                    li.textContent=`${e.name}: ${d.toLocaleTimeString()} - ${new Date(e.endTime).toLocaleTimeString()} | ${(hrs>0?hrs+'—á ':'')+(mins>0?mins+'–º–∏–Ω ':'')+secs+'—Å–µ–∫'}`; 
                    l.appendChild(li);
                });
            }

            function getCurrentTransformY() { return new WebKitCSSMatrix(window.getComputedStyle(document.getElementById('reel-items')).transform).m42; }
            function updateDisplay(y) {
                const i = Math.abs(Math.round(y/itemHeight));
                if(i<activities.length) {
                    const a=activities[i];
                    document.getElementById('main-reel').classList.toggle('active-activity', !!(activeActivity));
                    document.getElementById('current-activity-display').innerHTML = `–ò–∑–±—Ä–∞–Ω–∞: <span style="padding:2px 5px;border-radius:4px;background-color:${a.bg};color:${a.text}">${a.name}</span>. –î–æ–∫–æ—Å–Ω–µ—Ç–µ –∑–∞ —Å—Ç–∞—Ä—Ç.`;
                }
            }
            function snapToClosestItem() {
                let y=getCurrentTransformY(); let f=Math.max(-(activities.length-1)*itemHeight, Math.min(0, Math.round(y/itemHeight)*itemHeight));
                document.getElementById('reel-items').style.transform=`translateY(${f}px)`; currentTranslateY=f; updateDisplay(f);
            }
            function handleTap() {
                snapToClosestItem();
                const i=Math.abs(Math.round(getCurrentTransformY()/itemHeight)); if(i>=activities.length) return;
                const n=activities[i].name, now=new Date().toISOString();
                if(activeActivity && activeActivity.colorIndex===i) return;
                if(activeActivity) activityData.push({name:activeActivity.name, colorIndex:activeActivity.colorIndex, startTime:activeActivity.startTime, endTime:now});
                activeActivity={name:n, startTime:now, colorIndex:i}; renderLog(); saveState();
            }
            function handleTouchStart(e) { isDragging=false; startY=e.touches[0].clientY; currentTranslateY=getCurrentTransformY(); document.getElementById('reel-items').style.transition='none'; pressTimer=setTimeout(()=>{if(!isDragging){const i=Math.abs(Math.round(currentTranslateY/itemHeight)); const nn=prompt("–†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ:",activities[i].name); if(nn){activities[i].name=nn;generateReelContent();saveState();updateDisplay(currentTranslateY);}}},700); }
            function handleTouchMove(e) { const dy=e.touches[0].clientY-startY; if(Math.abs(dy)>5){isDragging=true;clearTimeout(pressTimer);} const ny=Math.max(-(activities.length-1)*itemHeight, Math.min(0, currentTranslateY+dy)); document.getElementById('reel-items').style.transform=`translateY(${ny}px)`; }
            function handleTouchEnd() { clearTimeout(pressTimer); document.getElementById('reel-items').style.transition='transform 0.2s ease-out'; if(isDragging) snapToClosestItem(); else handleTap(); isDragging=false; }

            window.generateTestData = function() {
                activityData = []; activeActivity = null; const now = new Date();
                for (let i = 0; i < 3; i++) {
                    let day = new Date(now); day.setDate(day.getDate() - i);
                    activityData.push({ name: "–ó–∞–∫—É—Å–∫–∞", colorIndex: 3, startTime: new Date(day.setHours(8,0)).toISOString(), endTime: new Date(day.setHours(9,0)).toISOString() });
                    activityData.push({ name: "–†–∞–±–æ—Ç–∞", colorIndex: 7, startTime: new
